<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Text Component Generator</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        :root {
    --background-color-light: #f0f0f0;
    --background-color-dark: #1a1a1a;
    --text-color-light: #333;
    --text-color-dark: #ddd;
    --panel-background-color-light: #ffffff;
    --panel-background-color-dark: #2b2b2b;
    --border-color-light: #ccc;
    --border-color-dark: #444;
    --primary-color: #55a630;
    --primary-color-dark: #407f22;
    --accent-color: #ff4081;
    --accent-color-dark: #c2185b;
    --footer-link-color: #55a630;
    --developer-link-color: #0eb0f0;
    --donate-link-color: #ff4081;
    --donate-link-hover-color: #ff7091;
    --shadow-light: 0 8px 20px rgba(0, 0, 0, 0.1);
    --shadow-dark: 0 8px 20px rgba(0, 0, 0, 0.5);
    --transition-speed: 0.3s;
    --sent-message-bg: #55a630;
    --received-message-bg: #4e4e4e;
    --sent-message-text-color: white;
    --received-message-text-color: white;
    --developer-message-bg: #ff4081;
    --developer-message-text-color: white;
    --time-username-spacing: 10px;
    --modal-background-color: rgba(0, 0, 0, 0.6);
    --modal-content-background: var(--panel-background-color);
}

[data-theme="light"] {
    --background-color: var(--background-color-light);
    --text-color: var(--text-color-light);
    --panel-background-color: var(--panel-background-color-light);
    --border-color: var(--border-color-light);
    --shadow: var(--shadow-light);
    --scrollbar-color: #ccc;
    --language-button-color: var(--primary-color);
}

[data-theme="dark"] {
    --background-color: var(--background-color-dark);
    --text-color: var(--text-color-dark);
    --panel-background-color: var(--panel-background-color-dark);
    --border-color: var(--border-color-dark);
    --shadow: var(--shadow-dark);
    --scrollbar-color: #555;
    --language-button-color: var(--primary-color-dark);
}

* {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
}

body {
    font-family: 'Roboto', sans-serif;
    background-color: var(--background-color);
    color: var(--text-color);
    transition: background-color var(--transition-speed), color var(--transition-speed);
    line-height: 1.6;
    padding: 20px;
    overflow-x: hidden;
}

::-webkit-scrollbar {
    width: 8px;
}

::-webkit-scrollbar-thumb {
    background-color: var(--scrollbar-color);
    border-radius: 4px;
}

header, footer {
    width: 100%;
    background-color: var(--panel-background-color);
    padding: 10px;
    box-shadow: var(--shadow);
    display: flex;
    justify-content: space-between;
    align-items: center;
    position: fixed;
    z-index: 1000;
    transition: background-color var(--transition-speed), box-shadow var(--transition-speed), color var(--transition-speed);
}

header {
    top: 0;
    left: 0;
}

footer {
    bottom: 0;
    left: 0;
    color: var(--footer-link-color);
}

header h1, footer p {
    color: var(--primary-color);
}

.header-right {
    display: flex;
    align-items: center;
    gap: 15px;
}

.home-button, .dropdown-button, .button {
    background-color: var(--primary-color);
    color: white;
    padding: 10px 20px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 16px;
    display: flex;
    align-items: center;
    gap: 10px;
    text-decoration: none;
    transition: all 0.3s ease;
    height: 41px;
}

.home-button:hover, .dropdown-button:hover, .button:hover {
    background-color: var(--primary-color-dark);
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
}

.home-button:active, .dropdown-button:active, .button:active {
    transform: translateY(0);
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

.dropdown {
    position: relative;
    display: inline-block;
}

.dropdown-content {
    display: none;
    position: absolute;
    background-color: var(--panel-background-color);
    min-width: 160px;
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
    z-index: 1001;
    border-radius: 8px;
    top: 100%;
    left: 0;
}

.dropdown-content a {
    color: var(--text-color);
    padding: 12px 16px;
    text-decoration: none;
    display: block;
    transition: background-color 0.3s ease;
}

.dropdown-content a:hover {
    background-color: var(--primary-color);
    color: white;
}

.dropdown:hover .dropdown-content {
    display: block;
}

#theme-switcher, #language-switcher, #login-btn {
    font-size: 20px;
    cursor: pointer;
    color: var(--primary-color);
    transition: all 0.3s ease;
}

#theme-switcher:hover, #language-switcher:hover, #login-btn:hover {
    transform: scale(1.1);
}

.language-button {
    background-color: transparent;
    border: none;
    outline: none;
    color: var(--language-button-color);
}

.container {
    display: flex;
    justify-content: space-between;
    max-width: 1200px;
    margin: 0 auto;
    padding-top: 70px;
    padding-bottom: 50px;
    gap: 20px;
}

.panel {
    background-color: var(--panel-background-color);
    padding: 20px;
    border-radius: 12px;
    box-shadow: var(--shadow);
    transition: background-color var(--transition-speed), box-shadow var(--transition-speed);
    animation: fadeIn var(--transition-speed) ease-in-out;
}

.left-panel {
    width: 48%;
    max-height: calc(100vh - 140px);
    overflow-y: auto;
    position: relative;
}

#right-panel {
    position: fixed;
    right: 20px;
    top: 70px;
    width: calc(48% - 40px);
    height: calc(100vh - 140px);
    overflow-y: auto;
    padding-bottom: 20px;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

.panel h2 {
    font-size: 20px;
    color: var(--primary-color);
    margin-bottom: 10px;
    display: flex;
    align-items: center;
}

.panel-content {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

input[type="text"],
select,
textarea {
    width: 100%;
    padding: 8px;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    background-color: var(--panel-background-color);
    color: var(--text-color);
    transition: border-color var(--transition-speed), box-shadow var(--transition-speed);
}

input[type="text"]:focus,
select:focus,
textarea:focus {
    border-color: var(--primary-color);
    outline: none;
    box-shadow: 0 0 5px rgba(0, 123, 255, 0.2);
}

.button {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 8px 16px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    transition: background-color var(--transition-speed), box-shadow var(--transition-speed), transform var(--transition-speed);
    font-size: 16px;
    margin-top: 8px;
    color: #fff;
}

.button-primary {
    background-color: var(--primary-color);
}

.button-primary:hover {
    background-color: var(--primary-color-dark);
    box-shadow: var(--shadow);
    transform: translateY(-2px);
}

.button-accent {
    background-color: var(--accent-color);
}

.button-accent:hover {
    background-color: var(--accent-color-dark);
    box-shadow: var(--shadow);
    transform: translateY(-2px);
}

.output-panel {
    margin-top: 15px;
    border: 1px solid var(--border-color);
}

textarea#json-area,
#preview-content {
    height: 200px;
    resize: vertical;
    overflow-y: auto;
}

.footer-links a {
    color: var(--footer-link-color);
    text-decoration: none;
    margin: 0 10px;
    font-size: 16px;
    transition: all 0.3s ease;
}

.footer-links a[aria-label="YouTube"] {
    color: #FF0000;
}

.footer-links a[aria-label="Instagram"] {
    color: #E1306C;
}

.footer-links a[aria-label="Discord"] {
    color: #7289DA;
}

.footer-links a:hover {
    transform: translateY(-2px);
    text-decoration: underline;
}

#developer-link {
    font-weight: bold;
    color: var(--developer-link-color);
    text-decoration: none;
    transition: all 0.3s ease;
}

#developer-link:hover {
    transform: translateY(-2px);
    text-decoration: underline;
}

.donate {
    display: flex;
    align-items: center;
    cursor: pointer;
    color: var(--donate-link-color);
    margin-left: 10px;
    text-decoration: none;
    transition: all 0.3s ease;
}

.donate i {
    margin-right: 5px;
}

.donate:hover {
    color: var(--donate-link-hover-color);
    transform: translateY(-2px);
}

@media (max-width: 768px) {
    .container {
        flex-direction: column;
        padding-top: 60px;
        padding-left: 20px;
        padding-right: 20px;
    }

    .panel {
        width: 100%;
    }

    #right-panel {
        position: static;
        width: 100%;
        height: auto;
    }
}

.content {
    margin-bottom: 10px;
    padding: 10px;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    background-color: var(--panel-background-color);
    transition: box-shadow var(--transition-speed);
    display: flex;
    flex-direction: column;
    gap: 10px;
    cursor: grab;
    color: var(--text-color);
}

.content.dragging {
    opacity: 0.5;
    box-shadow: var(--shadow);
}

.content-controls {
    display: flex;
    gap: 10px;
    justify-content: flex-start;
}

.chat-button {
    position: fixed;
    bottom: 80px;
    right: 20px;
    background-color: var(--primary-color);
    color: white;
    border: none;
    border-radius: 50%;
    padding: 15px;
    font-size: 18px;
    cursor: pointer;
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
    z-index: 1001;
    transition: all 0.3s ease;
}

.chat-button:hover {
    transform: scale(1.1);
    box-shadow: 0 12px 24px rgba(0, 0, 0, 0.2);
}

.unread-dot {
    position: absolute;
    top: 5px;
    right: 5px;
    width: 10px;
    height: 10px;
    background-color: red;
    border-radius: 50%;
    display: none;
}

#chat-container {
    width: 400px;
    height: 500px;
    position: fixed;
    bottom: 140px;
    right: 20px;
    border: 1px solid var(--border-color);
    border-radius: 10px;
    display: none;
    background-color: var(--panel-background-color);
    z-index: 1002;
    flex-direction: column;
}

#chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 10px;
    background-color: var(--panel-background-color);
    word-wrap: break-word;
    word-break: break-word;
    display: flex;
    flex-direction: column;
}

#chat-messages::-webkit-scrollbar {
    width: 8px;
}

#chat-messages::-webkit-scrollbar-track {
    background: var(--panel-background-color);
}

#chat-messages::-webkit-scrollbar-thumb {
    background-color: var(--scrollbar-color);
    border-radius: 10px;
}

#chat-messages li {
    margin-bottom: 20px;
    display: flex;
    flex-direction: column;
    max-width: 80%;
}

#chat-messages li.sent {
    align-self: flex-end;
    align-items: flex-end;
}

#chat-messages li.sent .message-header {
    flex-direction: row-reverse;
}

#chat-messages li.sent .message-header img {
    margin-left: 5px;
    margin-right: 0;
}

#chat-messages li.sent .username {
    margin-right: 5px;
    margin-left: 0;
}

#chat-messages .message-header {
    display: flex;
    align-items: center;
    margin-bottom: 5px;
    font-size: 0.9em;
}

#chat-messages .message-header img {
    width: 24px;
    height: 24px;
    border-radius: 50%;
}

#chat-messages li.received .message-header img {
    margin-right: 5px;
}

#chat-messages .username {
    font-weight: bold;
}

#chat-messages li.received .username {
    margin-left: 5px;
}

#chat-messages li.received {
    align-self: flex-start;
    align-items: flex-start;
}

#chat-messages .message-content {
    padding: 10px 15px;
    border-radius: 10px;
    background-color: var(--received-message-bg);
    color: var(--received-message-text-color);
    word-wrap: break-word;
    overflow-wrap: break-word;
}

#chat-messages li.sent .message-content {
    background-color: var(--sent-message-bg);
    color: var(--sent-message-text-color);
}

#chat-messages li.developer .message-content {
    background-color: var(--developer-message-bg);
    color: var(--developer-message-text-color);
}

#chat-messages li.developer .username {
    color: var(--developer-link-color);
}

#chat-messages .message-time {
    font-size: 0.8em;
    color: #888;
    margin-top: 5px;
    align-self: flex-end; /* Align timestamp to the right for all messages */
}

#chat-messages li.sent .message-time {
    align-self: flex-end; /* Align to the right for sent messages */
}

#chat-messages li.received .message-time {
    align-self: flex-start; /* Align to the left for received messages */
}

#chat-input {
    display: flex;
    padding: 10px;
    background-color: var(--panel-background-color);
    border-top: 1px solid var(--border-color);
}

#chat-input input {
    flex: 1;
    padding: 10px;
    border: 1px solid var(--border-color);
    border-radius: 5px;
    margin-right: 10px;
    background-color: var(--panel-background-color);
    color: var(--text-color);
}

#chat-input button {
    padding: 10px 20px;
    border: none;
    background-color: var(--primary-color);
    color: white;
    border-radius: 5px;
    cursor: pointer;
    transition: all 0.3s ease;
}

#chat-input button:hover {
    background-color: var(--primary-color-dark);
    transform: translateY(-2px);
}

#login-modal, #username-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: var(--modal-background-color);
    z-index: 1100;
    align-items: center;
    justify-content: center;
}

#login-modal-content, #username-modal-content {
    background-color: var(--modal-content-background);
    padding: 20px;
    border-radius: 10px;
    text-align: center;
}

#login-modal-content h3, #username-modal-content h3 {
    margin-bottom: 20px;
    color: var(--text-color);
}

.login-method-button, #setUsernameBtn {
    margin: 10px;
    padding: 10px 20px;
    background-color: var(--primary-color);
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-size: 16px;
    transition: all 0.3s ease;
}

.login-method-button:hover, #setUsernameBtn:hover {
    background-color: var(--primary-color-dark);
    transform: translateY(-2px);
}

.close-modal {
    margin-top: 20px;
    cursor: pointer;
    color: var(--text-color);
    font-size: 14px;
    text-decoration: underline;
    transition: all 0.3s ease;
}

.close-modal:hover {
    color: var(--primary-color);
}

#chat-messages .message-header {
    display: flex;
    align-items: center;
    margin-bottom: 5px;
    font-size: 0.9em;
}

#chat-messages .message-header img {
    width: 24px;
    height: 24px;
    border-radius: 50%;
}

#chat-messages .username {
    font-weight: bold;
}

#chat-messages .message-time {
    font-size: 0.8em;
    color: #888;
    margin-top: 5px;
    align-self: flex-end; /* Align timestamp to the right for all messages */
}

#chat-messages li.sent .message-time {
    align-self: flex-end; /* Align to the right for sent messages */
}

#chat-messages li.received .message-time {
    align-self: flex-start; /* Align to the left for received messages */
}
    </style>
</head>
<body data-theme="dark">
    <header>
        <h1><i class="fas fa-cogs"></i> <span id="headerTitle">Text Component Generator</span></h1>
        <div class="header-right">
            <a href="https://nosmc.github.io" class="home-button" aria-label="Home">
                <i class="fas fa-home"></i> <span id="home">Home</span>
            </a>
            <div class="dropdown">
                <button class="dropdown-button" aria-label="Generators"><i class="fas fa-caret-down"></i> <span id="generators">Generators</span></button>
                <div class="dropdown-content">
                    <a href="#" data-generator="text"><span id="generatorText">Text</span></a>
                    <a href="#" data-generator="item"><span id="generatorItem">Item</span></a>
                    <a href="#" data-generator="entity"><span id="generatorEntity">Entity</span></a>
                </div>
            </div>
            <button class="language-button" id="language-switcher" aria-label="Switch Language">
                <i class="fas fa-language"></i>
            </button>
            <div id="theme-switcher" aria-label="Switch Theme"><i class="fas fa-adjust"></i></div>
            <div id="login-btn" aria-label="Login"><i class="fas fa-user"></i></div>
        </div>
    </header>

    <div class="container">
        <div class="panel left-panel">
            <h2><i class="fas fa-list"></i> <span id="contentList">Content List</span></h2>
            <div id="content-list"></div>

            <div class="panel-content">
                <label for="content-type"><span id="contentType">Content Type:</span></label>
                <select id="content-type">
                    <option value="plainText" id="plainTextOption">Plain Text</option>
                    <option value="translatedText" id="translatedTextOption">Translated Text</option>
                    <option value="score" id="scoreOption">Score</option>
                    <option value="selector" id="selectorOption">Selector</option>
                    <option value="keybind" id="keybindOption">Keybind</option>
                    <option value="nbt" id="nbtOption">NBT</option>
                    <option value="linebreak" id="linebreakOption">Line Break</option>
                </select>
                <button id="add-content-btn" class="button button-primary" aria-label="Add Content"><i class="fas fa-plus-circle"></i> <span id="addContent">Add Content</span></button>
            </div>
        </div>

        <div id="right-panel" class="panel">
            <div class="output-panel">
                <h2><i class="fas fa-code"></i> <span id="jsonEditor">JSON Editor</span></h2>
                <div>
                    <label for="indentation"><span id="jsonIndentation">JSON Indentation:</span></label>
                    <select id="indentation">
                        <option value="none">None</option>
                        <option value="2">2 Spaces</option>
                        <option value="4">4 Spaces</option>
                    </select>
                </div>
                <textarea id="json-area"></textarea>
                <button id="copy-json-btn" class="button button-accent" aria-label="Copy JSON"><i class="fas fa-copy"></i> <span id="copyJson">Copy JSON</span></button>
                <button id="clear-all-btn" class="button button-accent" aria-label="Clear All"><i class="fas fa-trash-alt"></i> <span id="clearAll">Clear All</span></button>
            </div>

            <div id="html-preview" class="panel">
                <h2><i class="fas fa-eye"></i> <span id="preview">Preview</span></h2>
                <div id="preview-content"></div>
            </div>
        </div>
    </div>

    <footer>
        <div class="footer-links">
            <a href="https://www.youtube.com/@n_os_" target="_blank" style="color: #FF0000;" aria-label="YouTube"><i class="fab fa-youtube"></i> <span id="youtube">YouTube</span></a>
            <a href="https://www.instagram.com/" target="_blank" style="color: #E1306C;" aria-label="Instagram"><i class="fab fa-instagram"></i> <span id="instagram">Instagram</span></a>
            <a href="https://discord.gg/Pah6vw36Tw" target="_blank" style="color: #7289DA;" aria-label="Discord"><i class="fab fa-discord"></i> <span id="discord">Discord</span></a>
        </div>
        <p>
            <a id="developer-link" href="https://github.com/nosmc" target="_blank">&copy; <span id="developedBy">Developed by nos</span></a>
            <a href="https://donation-link.com" target="_blank" class="donate"><i class="fas fa-heart"></i> <span id="donate">Donate</span></a>
        </p>
    </footer>

    <!-- Chat Container -->
    <div id="chat-container">
        <h2><i class="fas fa-comments"></i> <span id="chatTitle">Chat</span></h2>
        <ul id="chat-messages"></ul>
        <div id="chat-input">
            <input type="text" id="message-input" placeholder="Type a message..." aria-label="Message Input">
            <button id="send-button"><span id="sendButtonText">Send</span></button>
        </div>
    </div>

    <button class="chat-button" aria-label="Open Chat">
        <i class="fas fa-comments"></i>
        <span class="unread-dot"></span>
    </button>

    <!-- Login Modal -->
    <div id="login-modal">
        <div id="login-modal-content">
            <h3 id="chooseLoginMethod">Choose a Login Method</h3>
            <button id="login-google" class="login-method-button">
                <span id="loginWithGoogle">Login with Google</span>
            </button>
            <button id="login-github" class="login-method-button">
                <span id="loginWithGithub">Login with GitHub</span>
            </button>
            <div class="close-modal" id="close-login-modal">
                <span id="cancelLogin">Cancel</span>
            </div>
        </div>
    </div>

    <!-- Username Modal -->
    <div id="username-modal">
        <div id="username-modal-content">
            <h3 id="setUsernameTitle">Set Your Username</h3>
            <input type="text" id="username-input" placeholder="Enter your username">
            <!-- The error message will be inserted here -->
            <button id="setUsernameBtn">Set Username</button>
            <div class="close-modal" id="close-username-modal">
                <span id="cancelSetUsername">Cancel</span>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.0/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.0/mode/javascript/javascript.min.js"></script>
    <script type="module">
        // Import Firebase SDKs
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
import { getAuth, GithubAuthProvider, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";
import { getDatabase, ref, push, onChildAdded, query, orderByChild, set, get, equalTo } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-database.js";

// Firebase configuration
const firebaseConfig = {
    apiKey: "AIzaSyDzku7AoSdbF7GzZTJEtVj5beyl1MnrTAk",
    authDomain: "minecraft-generators.firebaseapp.com",
    databaseURL: "https://minecraft-generators-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "minecraft-generators",
    storageBucket: "minecraft-generators.appspot.com",
    messagingSenderId: "191346462383",
    appId: "1:191346462383:web:6c8759e5ee2f676594ce5a",
    measurementId: "G-QJT1XPTPDZ"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const database = getDatabase(app);

// Global variables
let currentUser = null;
let username = null;
let messagesRef = null;
const developerUsername = "nos";
let currentLanguage = 'en';
let isSettingUsername = false;
let hasSetUsername = false;
let contents = JSON.parse(localStorage.getItem('contents')) || [];
let dragSrcIndex = null;
let scrollInterval = null;

const minecraftColorMap = {
    black: '#000000',
    dark_blue: '#0000AA',
    dark_green: '#00AA00',
    dark_aqua: '#00AAAA',
    dark_red: '#AA0000',
    dark_purple: '#AA00AA',
    gold: '#FFAA00',
    gray: '#AAAAAA',
    dark_gray: '#555555',
    blue: '#5555FF',
    green: '#55FF55',
    aqua: '#55FFFF',
    red: '#FF5555',
    light_purple: '#FF55FF',
    yellow: '#FFFF55',
    white: '#FFFFFF'
};

// DOM elements
const messageInput = document.getElementById('message-input');
const sendButton = document.getElementById('send-button');
const messagesList = document.getElementById('chat-messages');
const chatContainer = document.getElementById('chat-container');
const chatButton = document.querySelector('.chat-button');
const loginButton = document.getElementById('login-btn');
const loginModal = document.getElementById('login-modal');
const closeLoginModal = document.getElementById('close-login-modal');
const googleLoginBtn = document.getElementById('login-google');
const githubLoginBtn = document.getElementById('login-github');
const themeSwitcher = document.getElementById('theme-switcher');
const body = document.body;
const languageSwitcher = document.getElementById('language-switcher');
const usernameModal = document.getElementById('username-modal');
const usernameInput = document.getElementById('username-input');
const setUsernameBtn = document.getElementById('setUsernameBtn');
const closeUsernameModal = document.getElementById('close-username-modal');

// Auth Providers
const githubProvider = new GithubAuthProvider();
const googleProvider = new GoogleAuthProvider();

// Event Listeners
chatButton.addEventListener('click', toggleChat);
loginButton.addEventListener('click', handleLoginButtonClick);
closeLoginModal.addEventListener('click', () => loginModal.style.display = 'none');
googleLoginBtn.addEventListener('click', () => signInWithProvider(googleProvider));
githubLoginBtn.addEventListener('click', () => signInWithProvider(githubProvider));
sendButton.addEventListener('click', sendMessage);
messageInput.addEventListener('keypress', handleMessageInputKeypress);
themeSwitcher.addEventListener('click', toggleTheme);
languageSwitcher.addEventListener('click', toggleLanguage);
document.getElementById('add-content-btn').addEventListener('click', () => {
    const contentType = document.getElementById('content-type').value;
    addContent(contentType);
});
document.getElementById('copy-json-btn').addEventListener('click', copyJsonToClipboard);
document.getElementById('clear-all-btn').addEventListener('click', clearAll);
document.getElementById('indentation').addEventListener('change', updateOutputAndPreview);
setUsernameBtn.addEventListener('click', handleSetUsername);
closeUsernameModal.addEventListener('click', () => {
    usernameModal.style.display = 'none';
    signOut(auth);
});

// Dropdown Menu Redirection
document.querySelectorAll('.dropdown-content a').forEach(link => {
    link.addEventListener('click', handleGeneratorRedirect);
});

// Initialize the page
window.addEventListener('DOMContentLoaded', initializePage);

// Firebase Auth State Change
auth.onAuthStateChanged(handleAuthStateChange);

// Functions
function toggleChat() {
    const isChatOpen = chatContainer.style.display === 'flex';
    chatContainer.style.display = isChatOpen ? 'none' : 'flex';
    if (!isChatOpen) {
        messagesList.scrollTop = messagesList.scrollHeight;
    }
}

function handleLoginButtonClick() {
    if (currentUser) {
        signOut(auth).then(() => {
            currentUser = null;
            username = null;
            hasSetUsername = false;
            removeMessagesListener();
        }).catch(error => {
            console.error("Error signing out:", error);
        });
    } else {
        loginModal.style.display = 'flex';
    }
}

function signInWithProvider(provider) {
    signInWithPopup(auth, provider).then(result => {
        currentUser = result.user;
        loginModal.style.display = 'none';
        checkUsername();
    }).catch(error => {
        console.error(`Error during ${provider.providerId} login:`, error);
    });
}

function handleAuthStateChange(user) {
    if (user) {
        currentUser = user;
        loginButton.innerHTML = `<i class="fas fa-sign-out-alt"></i>`;
        loginButton.setAttribute('aria-label', 'Logout');
        if (!hasSetUsername) {
            checkUsername();
        }
    } else {
        loginButton.innerHTML = `<i class="fas fa-user"></i>`;
        loginButton.setAttribute('aria-label', 'Login');
        currentUser = null;
        username = null;
        hasSetUsername = false;
        removeMessagesListener();
    }
}

function checkUsername() {
    if (isSettingUsername || hasSetUsername) return;
    
    isSettingUsername = true;
    const userRef = ref(database, `users/${currentUser.uid}`);
    get(userRef).then(snapshot => {
        if (snapshot.exists()) {
            username = snapshot.val().username;
            hasSetUsername = true;
            loadMessages();
        } else {
            showUsernameModal();
        }
    }).catch(error => {
        console.error("Error checking username:", error);
        showUsernameModal();
    }).finally(() => {
        isSettingUsername = false;
    });
}

function showUsernameModal() {
    usernameModal.style.display = 'flex';
    usernameInput.focus();
}

function handleSetUsername() {
    const newUsername = usernameInput.value.trim();
    if (newUsername) {
        saveUsername(newUsername);
    } else {
        alert(translations[currentLanguage].usernameEmpty);
    }
}

function saveUsername(newUsername) {
    const usernamesRef = ref(database, 'users');
    const usernameQuery = query(usernamesRef, orderByChild('username'), equalTo(newUsername));

    get(usernameQuery).then(snapshot => {
        if (snapshot.exists()) {
            showUsernameError(translations.usernameExists[currentLanguage]);
            usernameInput.value = '';
            usernameInput.focus();
        } else {
            set(ref(database, `users/${currentUser.uid}`), {
                username: newUsername
            }).then(() => {
                username = newUsername;
                hasSetUsername = true;
                usernameModal.style.display = 'none';
                loadMessages();
            }).catch(error => {
                console.error("Error saving username:", error);
                showUsernameError(translations.errorSavingUsername[currentLanguage]);
            });
        }
    }).catch(error => {
        console.error("Error checking username uniqueness:", error);
        showUsernameError(translations.errorCheckingUsername[currentLanguage]);
    });
}

function showUsernameError(message) {
    const errorElement = document.getElementById('username-error');
    if (!errorElement) {
        const newErrorElement = document.createElement('p');
        newErrorElement.id = 'username-error';
        newErrorElement.style.color = 'red';
        newErrorElement.style.marginTop = '10px';
        document.getElementById('username-modal-content').insertBefore(newErrorElement, document.getElementById('setUsernameBtn'));
    }
    document.getElementById('username-error').textContent = message;
}

function loadMessages() {
    if (messagesRef) {
        return;
    }
    messagesRef = query(ref(database, 'messages'), orderByChild('timestamp'));
    onChildAdded(messagesRef, (snapshot) => {
        const message = snapshot.val();
        displayMessage(message);
    });
}

function removeMessagesListener() {
    if (messagesRef) {
        messagesRef = null;
    }
    messagesList.innerHTML = '';
}

function convertToLocalTime(isoTimestamp) {
    const date = new Date(isoTimestamp);
    return date.toLocaleString();
}

function displayMessage(message) {
    const li = document.createElement('li');
    li.className = message.sender === username ? 'sent' : 'received';

    if (message.sender === developerUsername) {
        li.classList.add('developer');
    }

    const messageHeader = document.createElement('div');
    messageHeader.className = 'message-header';

    const img = document.createElement('img');
    img.src = message.avatar || 'default-avatar.png';
    img.alt = message.sender;

    const usernameSpan = document.createElement('span');
    usernameSpan.className = 'username';
    usernameSpan.textContent = message.sender;

    const timeSpan = document.createElement('span');
    timeSpan.className = 'time';
    timeSpan.textContent = convertToLocalTime(message.timestamp);

    messageHeader.appendChild(usernameSpan);
    messageHeader.appendChild(timeSpan);

    if (li.className.includes('sent')) {
        messageHeader.appendChild(img);
    } else {
        messageHeader.insertBefore(img, usernameSpan);
    }

    li.appendChild(messageHeader);
    li.appendChild(messageContent);
    messagesList.appendChild(li);

    messagesList.scrollTop = messagesList.scrollHeight;
}

function sendMessage() {
    if (username && messageInput.value.trim()) {
        const timestamp = new Date().toISOString();

        push(ref(database, 'messages'), {
            sender: username,
            avatar: currentUser?.photoURL || "default-avatar.png",
            content: messageInput.value,
            timestamp: timestamp
        }).then(() => {
            messageInput.value = '';
            messageInput.focus();
        }).catch(error => {
            console.error("Error sending message:", error);
        });
    }
}

function handleMessageInputKeypress(e) {
    if (e.key === 'Enter') {
        sendMessage();
        e.preventDefault();
    }
}

function toggleTheme() {
    if (body.getAttribute('data-theme') === 'light') {
        body.setAttribute('data-theme', 'dark');
    } else {
        body.setAttribute('data-theme', 'light');
    }
    savePreferences();
}

function toggleLanguage() {
    currentLanguage = currentLanguage === 'en' ? 'zh' : 'en';
    translatePage();
    updateUI();
    savePreferences();
}

function savePreferences() {
    localStorage.setItem('theme', body.getAttribute('data-theme'));
    localStorage.setItem('language', currentLanguage);
}

function loadPreferences() {
    const savedTheme = localStorage.getItem('theme');
    const savedLanguage = localStorage.getItem('language');

    if (savedTheme) {
        body.setAttribute('data-theme', savedTheme);
    }
    if (savedLanguage) {
        currentLanguage = savedLanguage;
        translatePage();
    }
}

function translatePage() {
    Object.keys(translations).forEach(key => {
        const element = document.getElementById(key);
        if (element) {
            element.textContent = translations[key][currentLanguage];
        }
    });
    
    // Translate content type options
    document.getElementById('plainTextOption').textContent = translations.plainText[currentLanguage];
    document.getElementById('translatedTextOption').textContent = translations.translatedText[currentLanguage];
    document.getElementById('scoreOption').textContent = translations.score[currentLanguage];
    document.getElementById('selectorOption').textContent = translations.selector[currentLanguage];
    document.getElementById('keybindOption').textContent = translations.keybind[currentLanguage];
    document.getElementById('nbtOption').textContent = translations.nbt[currentLanguage];
    document.getElementById('linebreakOption').textContent = translations.linebreak[currentLanguage];

    // Translate JSON indentation options
    const indentationSelect = document.getElementById('indentation');
    indentationSelect.options[0].text = translations.none[currentLanguage];
    indentationSelect.options[1].text = translations.twoSpaces[currentLanguage];
    indentationSelect.options[2].text = translations.fourSpaces[currentLanguage];
    
    document.getElementById('message-input').placeholder = translations.typeAMessage[currentLanguage];
    document.getElementById('username-input').placeholder = translations.enterUsername[currentLanguage];
    
    // Update the error message if it exists
    const errorElement = document.getElementById('username-error');
    if (errorElement && errorElement.textContent) {
        errorElement.textContent = translations.usernameExists[currentLanguage];
    }
}

function handleGeneratorRedirect(e) {
    e.preventDefault();
    const generator = e.target.closest('[data-generator]').getAttribute('data-generator');
    if (generator) {
        let targetUrl;
        switch (generator) {
            case 'text':
                targetUrl = 'https://nosmc.github.io/generator/text';
                break;
            case 'item':
                targetUrl = 'https://nosmc.github.io/generator/item';
                break;
            case 'entity':
                targetUrl = 'https://nosmc.github.io/generator/entity';
                break;
            default:
                console.error('Unknown generator type:', generator);
                return;
        }

        function linkExists(url, callback) {
            fetch(url, { method: 'HEAD' })
                .then(response => callback(response.ok))
                .catch(() => callback(false));
        }

        linkExists(targetUrl, function(exists) {
            if (exists) {
                window.location.href = targetUrl;
            } else {
                window.location.href = 'https://nosmc.github.io/';
            }
        });
    }
}

function initializePage() {
    loadPreferences();
    translatePage();
    updateUI();
}

function createContent(type, data = {}) {
    return {
        type: type,
        data: {
            text: data.text || '',
            translate: data.translate || '',
            with: data.with || [],
            scoreName: data.scoreName || '',
            scoreObjective: data.scoreObjective || '',
            selector: data.selector || '',
            keybind: data.keybind || '',
            nbtPath: data.nbtPath || '',
            nbtSource: data.nbtSource || 'entity',
            storageSource: data.storageSource || '',
            interpret: data.interpret || false,
            color: data.color || 'none',
            bold: data.bold || false,
            italic: data.italic || false,
            underlined: data.underlined || false,
            strikethrough: data.strikethrough || false,
            obfuscated: data.obfuscated || false
        },
        clickEvent: { action: '', value: '' },
        hoverEvent: { action: '', contents: [] }
    };
}

function addContent(type) {
    let newContent;
    if (type === 'translatedText') {
        newContent = createContent(type, { translate: '', with: [] });
    } else {
        newContent = createContent(type);
    }
    contents.push(newContent);
    updateUI();
    saveContents();
}

function updateUI() {
    const contentList = document.getElementById('content-list');
    contentList.innerHTML = '';

    contents.forEach((content, index) => {
        const div = document.createElement('div');
        div.className = 'content';
        div.setAttribute('role', 'region');
        div.setAttribute('aria-labelledby', `content-label-${index}`);
        div.setAttribute('draggable', true);

        const contentLabel = document.createElement('label');
        contentLabel.className = 'content-label';
        contentLabel.id = `content-label-${index}`;
        const typeTranslation = translations[content.type] ? translations[content.type][currentLanguage] : content.type;
        contentLabel.innerHTML = `<i class="fas fa-cube"></i> ${translations.contentLabel[currentLanguage].replace('{number}', index + 1).replace('{type}', typeTranslation)}`;
        div.appendChild(contentLabel);

        // Add input fields based on content type
        if (content.type === 'plainText') {
            addTextInput(div, content, 'text', translations.enterText[currentLanguage]);
        } else if (content.type === 'translatedText') {
            addTextInput(div, content, 'translate', translations.enterTranslationKey[currentLanguage]);
            addWithInputs(div, content);
        } else if (content.type === 'score') {
            addTextInput(div, content, 'scoreName', translations.enterScoreName[currentLanguage]);
            addTextInput(div, content, 'scoreObjective', translations.enterScoreObjective[currentLanguage]);
        } else if (content.type === 'selector') {
            addTextInput(div, content, 'selector', translations.enterSelector[currentLanguage]);
        } else if (content.type === 'keybind') {
            addTextInput(div, content, 'keybind', translations.enterKeybind[currentLanguage]);
        } else if (content.type === 'nbt') {
            addTextInput(div, content, 'nbtPath', translations.enterNbtPath[currentLanguage]);
            addNbtSourceSelect(div, content);
            addCheckbox(div, content, 'interpret', translations.interpret[currentLanguage]);
        }

        // Add formatting options
        if (content.type !== 'linebreak') {
            addFormattingOptions(div, content);
            addEventOptions(div, content);
        }

        // Add control buttons
        addControlButtons(div, index);

        // Add drag-and-drop event listeners
        addDragAndDropListeners(div, index);

        contentList.appendChild(div);
    });

    updateOutputAndPreview();
}

function addTextInput(parent, content, field, placeholder) {
    const input = document.createElement('input');
    input.type = 'text';
    input.placeholder = placeholder;
    input.value = content.data[field];
    input.addEventListener('input', () => {
        content.data[field] = input.value;
        updateOutputAndPreview();
        saveContents();
    });
    parent.appendChild(input);
}

function addWithInputs(parent, content) {
    if (!Array.isArray(content.data.with)) {
        content.data.with = [];
    }
    
    content.data.with.forEach((withContent, withIndex) => {
        const withDiv = document.createElement('div');
        addTextInput(withDiv, withContent, 'text', `${translations.enterText[currentLanguage]} ${withIndex + 1}`);
        const deleteWithButton = createButton(translations.delete[currentLanguage], 'fa-trash', () => {
            content.data.with.splice(withIndex, 1);
            updateUI();
            saveContents();
        });
        withDiv.appendChild(deleteWithButton);
        parent.appendChild(withDiv);
    });

    const addWithButton = createButton(translations.addContent[currentLanguage], 'fa-plus', () => {
        content.data.with.push(createContent('plainText', { text: '' }));
        updateUI();
        saveContents();
    });
    parent.appendChild(addWithButton);
}

function addNbtSourceSelect(parent, content) {
    const select = document.createElement('select');
    ['entity', 'block', 'storage'].forEach(source => {
        const option = document.createElement('option');
        option.value = source;
        option.textContent = translations[source][currentLanguage];
        option.selected = content.data.nbtSource === source;
        select.appendChild(option);
    });
    select.addEventListener('change', () => {
        content.data.nbtSource = select.value;
        updateOutputAndPreview();
        saveContents();
    });
    parent.appendChild(select);

    if (content.data.nbtSource === 'storage') {
        addTextInput(parent, content, 'storageSource', translations.enterNbtPath[currentLanguage]);
    }
}

function addCheckbox(parent, content, field, label) {
    const checkbox = document.createElement('input');
    checkbox.type = 'checkbox';
    checkbox.checked = content.data && content.data[field] || false;
    checkbox.addEventListener('change', () => {
        if (!content.data) content.data = {};
        content.data[field] = checkbox.checked;
        updateOutputAndPreview();
        saveContents();
    });
    const labelElement = document.createElement('label');
    labelElement.appendChild(checkbox);
    labelElement.appendChild(document.createTextNode(label));
    parent.appendChild(labelElement);
}

function addFormattingOptions(parent, content) {
    const formattingDiv = document.createElement('div');
    formattingDiv.className = 'formatting-options';

    // Color selection
    const colorSelect = document.createElement('select');
    
    // Add "none" option
    const noneOption = document.createElement('option');
    noneOption.value = 'none';
    noneOption.textContent = translations.none[currentLanguage];
    noneOption.selected = !content.data.color || content.data.color === 'none';
    colorSelect.appendChild(noneOption);

    Object.keys(minecraftColorMap).forEach(color => {
        const option = document.createElement('option');
        option.value = color;
        option.textContent = translations[color][currentLanguage];
        option.selected = content.data && content.data.color === color;
        colorSelect.appendChild(option);
    });
    colorSelect.addEventListener('change', () => {
        if (!content.data) content.data = {};
        content.data.color = colorSelect.value;
        updateOutputAndPreview();
        saveContents();
    });
    formattingDiv.appendChild(colorSelect);

    // Text properties
    ['bold', 'italic', 'underlined', 'strikethrough', 'obfuscated'].forEach(prop => {
        addCheckbox(formattingDiv, content, prop, translations[prop][currentLanguage]);
    });

    parent.appendChild(formattingDiv);
}

function addEventOptions(parent, content) {
    // Click event options
    const clickEventDiv = document.createElement('div');
    clickEventDiv.className = 'event-options';
    const clickEventLabel = document.createElement('label');
    clickEventLabel.textContent = translations.clickEvent[currentLanguage];
    clickEventDiv.appendChild(clickEventLabel);

    const clickEventSelect = document.createElement('select');
    ['', 'open_url', 'open_file', 'run_command', 'suggest_command', 'change_page', 'copy_to_clipboard'].forEach(action => {
        const option = document.createElement('option');
        option.value = action;
        option.textContent = translations[action || 'noClickEvent'][currentLanguage];
        option.selected = content.clickEvent.action === action;
        clickEventSelect.appendChild(option);
    });
    clickEventSelect.addEventListener('change', () => {
        content.clickEvent.action = clickEventSelect.value;
        updateClickAndHoverEventInputs(clickEventValueInput, clickEventSelect.value);
        updateOutputAndPreview();
        saveContents();
    });
    clickEventDiv.appendChild(clickEventSelect);

    const clickEventValueInput = document.createElement('input');
    clickEventValueInput.type = 'text';
    clickEventValueInput.placeholder = translations.enterText[currentLanguage];
    clickEventValueInput.value = content.clickEvent.value;
    clickEventValueInput.style.display = content.clickEvent.action ? 'inline' : 'none';
    clickEventValueInput.addEventListener('input', () => {
        content.clickEvent.value = clickEventValueInput.value;
        updateOutputAndPreview();
        saveContents();
    });
    clickEventDiv.appendChild(clickEventValueInput);
    parent.appendChild(clickEventDiv);

    // Hover event options
    const hoverEventDiv = document.createElement('div');
    hoverEventDiv.className = 'event-options';
    const hoverEventLabel = document.createElement('label');
    hoverEventLabel.textContent = translations.hoverEvent[currentLanguage];
    hoverEventDiv.appendChild(hoverEventLabel);

    const hoverEventSelect = document.createElement('select');
    ['', 'show_text', 'show_item', 'show_entity'].forEach(action => {
        const option = document.createElement('option');
        option.value = action;
        option.textContent = translations[action || 'noHoverEvent'][currentLanguage];
        option.selected = content.hoverEvent.action === action;
        hoverEventSelect.appendChild(option);
    });
    hoverEventSelect.addEventListener('change', () => {
        content.hoverEvent.action = hoverEventSelect.value;
        updateClickAndHoverEventInputs(hoverEventContentsInput, hoverEventSelect.value);
        updateOutputAndPreview();
        saveContents();
    });
    hoverEventDiv.appendChild(hoverEventSelect);

    const hoverEventContentsInput = document.createElement('input');
    hoverEventContentsInput.type = 'text';
    hoverEventContentsInput.placeholder = translations.enterText[currentLanguage];
    hoverEventContentsInput.value = content.hoverEvent.contents.map(content => content.text).join(', ');
    hoverEventContentsInput.style.display = content.hoverEvent.action ? 'inline' : 'none';
    hoverEventContentsInput.addEventListener('input', () => {
        content.hoverEvent.contents = hoverEventContentsInput.value.split(',').map(item => ({ text: item.trim() }));
        updateOutputAndPreview();
        saveContents();
    });
    hoverEventDiv.appendChild(hoverEventContentsInput);
    parent.appendChild(hoverEventDiv);
}

function addControlButtons(parent, index) {
    const controlsDiv = document.createElement('div');
    controlsDiv.className = 'content-controls';

    const moveUpBtn = createButton(translations.moveUp[currentLanguage], 'fa-arrow-up', () => moveContent(index, -1));
    const moveDownBtn = createButton(translations.moveDown[currentLanguage], 'fa-arrow-down', () => moveContent(index, 1));
    const duplicateBtn = createButton(translations.duplicate[currentLanguage], 'fa-clone', () => duplicateContent(index));
    const deleteBtn = createButton(translations.delete[currentLanguage], 'fa-trash', () => deleteContent(index));

    controlsDiv.appendChild(moveUpBtn);
    controlsDiv.appendChild(moveDownBtn);
    controlsDiv.appendChild(duplicateBtn);
    controlsDiv.appendChild(deleteBtn);

    parent.appendChild(controlsDiv);
}

function createButton(text, iconClass, onClick) {
    const button = document.createElement('button');
    button.className = 'button button-accent';
    button.innerHTML = `<i class="fas ${iconClass}"></i> ${text}`;
    button.addEventListener('click', onClick);
    return button;
}

function addDragAndDropListeners(div, index) {
    div.addEventListener('dragstart', () => {
        dragSrcIndex = index;
        div.classList.add('dragging');
        startAutoScroll();
    });

    div.addEventListener('dragend', () => {
        div.classList.remove('dragging');
        stopAutoScroll();
        updateUI();
    });

    div.addEventListener('dragover', (e) => {
        e.preventDefault();
        const draggingElement = document.querySelector('.dragging');
        const contentList = document.getElementById('content-list');
        const afterElement = getDragAfterElement(contentList, e.clientY);
        if (afterElement == null) {
            contentList.appendChild(draggingElement);
        } else {
            contentList.insertBefore(draggingElement, afterElement);
        }
    });

    div.addEventListener('drop', () => {
        const draggedContent = contents.splice(dragSrcIndex, 1)[0];
        const dropIndex = Array.from(document.getElementById('content-list').children).indexOf(div);
        contents.splice(dropIndex, 0, draggedContent);
        updateUI();
        saveContents();
    });
}

function startAutoScroll() {
    scrollInterval = setInterval(() => {
        const container = document.querySelector('.left-panel');
        const headerRect = document.querySelector('header').getBoundingClientRect();
        const footerRect = document.querySelector('footer').getBoundingClientRect();
        const draggingElement = document.querySelector('.dragging');
        if (draggingElement) {
            const draggingRect = draggingElement.getBoundingClientRect();
            const scrollSpeed = 15;

            if (draggingRect.top < headerRect.bottom) {
                container.scrollTop -= scrollSpeed;
            } else if (draggingRect.bottom > footerRect.top) {
                container.scrollTop += scrollSpeed;
            }
        }
    }, 50);
}

function stopAutoScroll() {
    clearInterval(scrollInterval);
}

function getDragAfterElement(container, y) {
    const draggableElements = [...container.querySelectorAll('.content:not(.dragging)')];

    return draggableElements.reduce((closest, child) => {
        const box = child.getBoundingClientRect();
        const offset = y - box.top - box.height / 2;
        if (offset < 0 && offset > closest.offset) {
            return { offset: offset, element: child };
        } else {
            return closest;
        }
    }, { offset: Number.NEGATIVE_INFINITY }).element;
}

function updateClickAndHoverEventInputs(inputElement, action) {
    inputElement.style.display = action && action !== translations.noClickEvent[currentLanguage] && action !== translations.noHoverEvent[currentLanguage] ? 'inline' : 'none';
}

function moveContent(index, direction) {
    const newIndex = index + direction;
    if (newIndex >= 0 && newIndex < contents.length) {
        const temp = contents[index];
        contents[index] = contents[newIndex];
        contents[newIndex] = temp;
        updateUI();
        saveContents();
    }
}

function duplicateContent(index) {
    const newContent = JSON.parse(JSON.stringify(contents[index]));
    contents.splice(index + 1, 0, newContent);
    updateUI();
    saveContents();
}

function deleteContent(index) {
    contents.splice(index, 1);
    updateUI();
    saveContents();
}

function updateOutputAndPreview() {
    const output = contents.map(content => {
        let jsonContent = {};

        if (content.type === 'plainText') {
            jsonContent.text = content.data.text;
        } else if (content.type === 'translatedText') {
            jsonContent.translate = content.data.translate;
            if (content.data.with && content.data.with.length > 0) {
                jsonContent.with = content.data.with.map(withContent => ({ text: withContent.data.text }));
            }
        } else if (content.type === 'score') {
            jsonContent.score = {
                name: content.data.scoreName,
                objective: content.data.scoreObjective,
            };
        } else if (content.type === 'selector') {
            jsonContent.selector = content.data.selector;
        } else if (content.type === 'keybind') {
            jsonContent.keybind = content.data.keybind;
        } else if (content.type === 'nbt') {
            jsonContent.nbt = content.data.nbtPath;
            jsonContent[content.data.nbtSource] = content.data.storageSource || undefined;
            jsonContent.interpret = content.data.interpret;
        } else if (content.type === 'linebreak') {
            return "\n";
        }

        if (content.data.color !== 'none') {
            jsonContent.color = content.data.color;
        }
        if (content.data.bold) jsonContent.bold = content.data.bold;
        if (content.data.italic) jsonContent.italic = content.data.italic;
        if (content.data.underlined) jsonContent.underlined = content.data.underlined;
        if (content.data.strikethrough) jsonContent.strikethrough = content.data.strikethrough;
        if (content.data.obfuscated) jsonContent.obfuscated = content.data.obfuscated;

        if (content.clickEvent && content.clickEvent.action) {
            jsonContent.clickEvent = {
                action: content.clickEvent.action,
                value: content.clickEvent.value
            };
        }

        if (content.hoverEvent && content.hoverEvent.action) {
            jsonContent.hoverEvent = {
                action: content.hoverEvent.action,
                contents: content.hoverEvent.contents
            };
        }

        return jsonContent;
    });

    const indentation = document.getElementById('indentation').value;
    const jsonOutput = JSON.stringify(output, null, indentation === 'none' ? 0 : parseInt(indentation));
    document.getElementById('json-area').value = jsonOutput;

    updatePreview(output);
}

function updatePreview(output) {
    const previewDiv = document.getElementById('preview-content');
    previewDiv.innerHTML = ''; // Clear the previous content

    output.forEach(content => {
        if (content === '\n') {
            previewDiv.appendChild(document.createElement('br'));
            return;
        }

        const span = document.createElement('span');

        if (content.color && content.color !== 'none') {
            span.style.color = minecraftColorMap[content.color];
        }
        if (content.bold) span.style.fontWeight = 'bold';
        if (content.italic) span.style.fontStyle = 'italic';
        if (content.underlined) span.style.textDecoration = 'underline';
        if (content.strikethrough) span.style.textDecoration = (span.style.textDecoration ? span.style.textDecoration + ' ' : '') + 'line-through';
        if (content.obfuscated) span.style.filter = 'blur(2px)';

        let textContent = '';
        if (content.text) {
            textContent = content.text;
        } else if (content.translate) {
            textContent = content.translate;
        } else if (content.score) {
            textContent = `${content.score.name}:${content.score.objective}`;
        } else if (content.selector) {
            textContent = content.selector;
        } else if (content.keybind) {
            textContent = content.keybind;
        } else if (content.nbt) {
            textContent = content.nbt;
        }

        span.textContent = textContent;

        // Handle click events
        if (content.clickEvent) {
            span.className = 'click-event';
            span.style.cursor = 'pointer';
            span.addEventListener('click', () => {
                if (content.clickEvent.action === 'run_command') {
                    alert(`Running command: ${content.clickEvent.value}`);
                } else if (content.clickEvent.action === 'open_url') {
                    window.open(content.clickEvent.value, '_blank');
                } else if (content.clickEvent.action === 'suggest_command') {
                    alert(`Suggested command: ${content.clickEvent.value}`);
                } else if (content.clickEvent.action === 'change_page') {
                    alert(`Changing to page: ${content.clickEvent.value}`);
                } else if (content.clickEvent.action === 'copy_to_clipboard') {
                    navigator.clipboard.writeText(content.clickEvent.value).then(() => {
                        alert('Copied to clipboard!');
                    });
                }
            });
        }

        // Handle hover events
        if (content.hoverEvent && content.hoverEvent.action === 'show_text') {
            span.className = 'hover-event';
            span.title = content.hoverEvent.contents.map(content => content.text).join('');
        }

        previewDiv.appendChild(span);
        previewDiv.appendChild(document.createTextNode(' ')); // Add space between contents
    });
}

function copyJsonToClipboard() {
    const jsonArea = document.getElementById('json-area');
    jsonArea.select();
    document.execCommand('copy');
}

function clearAll() {
    contents = [];
    updateUI();
    document.getElementById('json-area').value = '';
    document.getElementById('preview-content').innerHTML = '';
    localStorage.removeItem('contents');
}

function saveContents() {
    localStorage.setItem('contents', JSON.stringify(contents));
}

// JSON input event listener
document.getElementById('json-area').addEventListener('input', debounce(() => {
    const jsonArea = document.getElementById('json-area').value;
    try {
        const parsedContents = JSON.parse(jsonArea);
        contents = parsedContents.map(parseJsonContent).filter(Boolean);
        updateUI();
        saveContents();
    } catch (e) {
        console.error("Invalid JSON input", e);
    }
}, 300));

function parseJsonContent(content) {
    if (typeof content === 'string' && content === '\n') {
        return createContent('linebreak');
    }

    let type, data = {};

    if (content.text !== undefined) {
        type = 'plainText';
        data.text = content.text;
    } else if (content.translate !== undefined) {
        type = 'translatedText';
        data.translate = content.translate;
        if (content.with) {
            data.with = content.with.map(withContent => ({ text: withContent.text }));
        }
    } else if (content.score !== undefined) {
        type = 'score';
        data.scoreName = content.score.name;
        data.scoreObjective = content.score.objective;
    } else if (content.selector !== undefined) {
        type = 'selector';
        data.selector = content.selector;
    } else if (content.keybind !== undefined) {
        type = 'keybind';
        data.keybind = content.keybind;
    } else if (content.nbt !== undefined) {
        type = 'nbt';
        data.nbtPath = content.nbt;
        data.nbtSource = content.storage ? 'storage' : content.block ? 'block' : 'entity';
        data.storageSource = content.storage || '';
        data.interpret = content.interpret || false;
    } else {
        return null; // Invalid content type
    }

    const newContent = createContent(type, data);

    newContent.data.color = content.color || 'none';
    newContent.data.bold = content.bold || false;
    newContent.data.italic = content.italic || false;
    newContent.data.underlined = content.underlined || false;
    newContent.data.strikethrough = content.strikethrough || false;
    newContent.data.obfuscated = content.obfuscated || false;

    if (content.clickEvent) {
        newContent.clickEvent = { action: content.clickEvent.action, value: content.clickEvent.value };
    }

    if (content.hoverEvent) {
        newContent.hoverEvent = {
            action: content.hoverEvent.action,
            contents: content.hoverEvent.contents || []
        };
    }

    return newContent;
}

function debounce(func, delay) {
    let timeout;
    return function (...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(this, args), delay);
    };
}

// Translations
const translations = {
    headerTitle: {
        en: "Text Component Generator",
        zh: "文本組件生成器"
    },
    home: {
        en: "Home",
        zh: "主頁"
    },
    generators: {
        en: "Generators",
        zh: "生成器"
    },
    generatorText: {
        en: "Text",
        zh: "文字"
    },
    generatorItem: {
        en: "Item",
        zh: "物品"
    },
    generatorEntity: {
        en: "Entity",
        zh: "實體"
    },
    contentList: {
        en: "Content List",
        zh: "內容列表"
    },
    addContent: {
        en: "Add Content",
        zh: "添加內容"
    },
    jsonEditor: {
        en: "JSON Editor",
        zh: "JSON 編輯器"
    },
    preview: {
        en: "Preview",
        zh: "預覽"
    },
    copyJson: {
        en: "Copy JSON",
        zh: "複製 JSON"
    },
    clearAll: {
        en: "Clear All",
        zh: "清除所有"
    },
    contentType: {
        en: "Content Type:",
        zh: "內容類型："
    },
    jsonIndentation: {
        en: "JSON Indentation:",
        zh: "JSON 縮進："
    },
    none: {
        en: "None",
        zh: "無"
    },
    twoSpaces: {
        en: "2 Spaces",
        zh: "2 個空格"
    },
    fourSpaces: {
        en: "4 Spaces",
        zh: "4 個空格"
    },
    plainText: {
        en: "Plain Text",
        zh: "純文本"
    },
    translatedText: {
        en: "Translated Text",
        zh: "翻譯文本"
    },
    score: {
        en: "Score",
        zh: "分數"
    },
    selector: {
        en: "Selector",
        zh: "選擇器"
    },
    keybind: {
        en: "Keybind",
        zh: "按鍵綁定"
    },
    nbt: {
        en: "NBT",
        zh: "NBT"
    },
    linebreak: {
        en: "Line Break",
        zh: "換行"
    },
    enterText: {
        en: "Enter text",
        zh: "輸入文本"
    },
    enterTranslationKey: {
        en: "Enter translation key",
        zh: "輸入翻譯鍵"
    },
    enterScoreName: {
        en: "Enter score name",
        zh: "輸入分數名稱"
    },
    enterScoreObjective: {
        en: "Enter score objective",
        zh: "輸入分數目標"
    },
    enterSelector: {
        en: "Enter selector",
        zh: "輸入選擇器"
    },
    enterKeybind: {
        en: "Enter keybind",
        zh: "輸入按鍵綁定"
    },
    enterNbtPath: {
        en: "Enter NBT path",
        zh: "輸入 NBT 路徑"
    },
    entity: {
        en: "Entity",
        zh: "實體"
    },
    block: {
        en: "Block",
        zh: "方塊"
    },
    storage: {
        en: "Storage",
        zh: "存儲"
    },
    interpret: {
        en: "Interpret",
        zh: "解釋"
    },
    noClickEvent: {
        en: "No Click Event",
        zh: "無點擊事件"
    },
    open_url: {
        en: "Open URL",
        zh: "打開 URL"
    },
    open_file: {
        en: "Open File",
        zh: "打開文件"
    },
    run_command: {
        en: "Run Command",
        zh: "運行命令"
    },
    suggest_command: {
        en: "Suggest Command",
        zh: "建議命令"
    },
    change_page: {
        en: "Change Page",
        zh: "更改頁面"
    },
    copy_to_clipboard: {
        en: "Copy to Clipboard",
        zh: "複製到剪貼板"
    },
    noHoverEvent: {
        en: "No Hover Event",
        zh: "無懸停事件"
    },
    show_text: {
        en: "Show Text",
        zh: "顯示文本"
    },
    show_item: {
        en: "Show Item",
        zh: "顯示物品"
    },
    show_entity: {
        en: "Show Entity",
        zh: "顯示實體"
    },
    bold: {
        en: "Bold",
        zh: "粗體"
    },
    italic: {
        en: "Italic",
        zh: "斜體"
    },
    underlined: {
        en: "Underlined",
        zh: "下劃線"
    },
    strikethrough: {
        en: "Strikethrough",
        zh: "刪除線"
    },
    obfuscated: {
        en: "Obfuscated",
        zh: "模糊"
    },
    clickEvent: {
        en: "Click Event:",
        zh: "點擊事件："
    },
    hoverEvent: {
        en: "Hover Event:",
        zh: "懸停事件："
    },
    moveUp: {
        en: "Move Up",
        zh: "上移"
    },
    moveDown: {
        en: "Move Down",
        zh: "下移"
    },
    duplicate: {
        en: "Duplicate",
        zh: "複製"
    },
    delete: {
        en: "Delete",
        zh: "刪除"
    },
    contentLabel: {
        en: "Content {number} ({type})",
        zh: "內容 {number} ({type})"
    },
    black: {
        en: "Black",
        zh: "黑色"
    },
    dark_blue: {
        en: "Dark Blue",
        zh: "深藍色"
    },
    dark_green: {
        en: "Dark Green",
        zh: "深綠色"
    },
    dark_aqua: {
        en: "Dark Aqua",
        zh: "深青色"
    },
    dark_red: {
        en: "Dark Red",
        zh: "深紅色"
    },
    dark_purple: {
        en: "Dark Purple",
        zh: "深紫色"
    },
    gold: {
        en: "Gold",
        zh: "金色"
    },
    gray: {
        en: "Gray",
        zh: "灰色"
    },
    dark_gray: {
        en: "Dark Gray",
        zh: "深灰色"
    },
    blue: {
        en: "Blue",
        zh: "藍色"
    },
    green: {
        en: "Green",
        zh: "綠色"
    },
    aqua: {
        en: "Aqua",
        zh: "青色"
    },
    red: {
        en: "Red",
        zh: "紅色"
    },
    light_purple: {
        en: "Light Purple",
        zh: "淺紫色"
    },
    yellow: {
        en: "Yellow",
        zh: "黃色"
    },
    white: {
        en: "White",
        zh: "白色"
    },
    chatTitle: {
        en: "Chat",
        zh: "聊天"
    },
    sendButtonText: {
        en: "Send",
        zh: "發送"
    },
    typeAMessage: {
        en: "Type a message...",
        zh: "輸入消息..."
    },
    chooseLoginMethod: {
        en: "Choose a Login Method",
        zh: "選擇登錄方式"
    },
    youtube: {
        en: "YouTube",
        zh: "YouTube"
    },
    instagram: {
        en: "Instagram",
        zh: "Instagram"
    },
    discord: {
        en: "Discord",
        zh: "Discord"
    },
    developedBy: {
        en: "Developed by nos",
        zh: "由 nos 開發"
    },
    donate: {
        en: "Donate",
        zh: "捐贈"
    },
    enterUsername: {
        en: "Please set your username:",
        zh: "請設置您的用戶名："
    },
    usernameExists: {
        en: "Username already exists. Please choose another one.",
        zh: "用戶名已存在。請選擇另一個。"
    },
    loginWithGoogle: {
        en: "Login with Google",
        zh: "使用 Google 登錄"
    },
    loginWithGithub: {
        en: "Login with GitHub",
        zh: "使用 GitHub 登錄"
    },
    cancelLogin: {
        en: "Cancel",
        zh: "取消"
    },
    setUsernameTitle: {
        en: "Set Your Username",
        zh: "設置您的用戶名"
    },
    setUsernameBtn: {
        en: "Set Username",
        zh: "設置用戶名"
    },
    cancelSetUsername: {
        en: "Cancel",
        zh: "取消"
    },
    usernameEmpty: {
        en: "Username cannot be empty",
        zh: "用戶名不能為空"
    },
    errorSavingUsername: {
        en: "Error saving username. Please try again.",
        zh: "保存用戶名時出錯。請重。"
    },
    errorCheckingUsername: {
        en: "Error checking username. Please try again.",
        zh: "檢查用戶名時出錯。請重試。"
    }
};

// Initialize the page
initializePage();
    </script>
</body>
</html>